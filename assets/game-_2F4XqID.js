const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BvqugAhF.js","assets/index-DnVUw_vK.css"])))=>i.map(i=>d[i]);
import{r as d,_ as O}from"./index-BvqugAhF.js";const f="/tetris/assets/clearline-DlFSzfFq.mp3",e={START_X_POSITION:3,START_Y_POSITION:0,INITIAL_SCORE:0,BOARD_COLUMNS:10,BOARD_ROWS:20,BLOCK_SIZE:30,ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",SPACE_KEY:" ",DIRECTION_LEFT:"left",DIRECTION_RIGHT:"right",COLORS:{I:"rgba(0, 233, 233, 0.9)",O:"rgba(200, 200, 0, 0.9)",Z:"rgba(200, 0, 0, 0.9)",S:"rgba(0, 150, 0, 0.9)",L:"rgba(255, 120, 0, 0.9)",J:"rgba(6, 78, 211, 0.9)",T:"rgba(100, 0, 100, 0.9)",GHOST:"rgba(0, 0, 0, 0.5)"},FALL_INTERVALS:{INITIAL:800,MIN:400,REDUCTION:100,STEP:15e3},SOUND_EFFECTS:{CLEAR_LINE:f}};class h{constructor(t,o){this.shape=t,this.color=o}static generateRandomTetromino(){const t=[{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:e.COLORS.I},{shape:[[1,1],[1,1]],color:e.COLORS.O},{shape:[[1,1,0],[0,1,1],[0,0,0]],color:e.COLORS.Z},{shape:[[0,1,1],[1,1,0],[0,0,0]],color:e.COLORS.S},{shape:[[1,0,0],[1,1,1],[0,0,0]],color:e.COLORS.J},{shape:[[0,0,1],[1,1,1],[0,0,0]],color:e.COLORS.L},{shape:[[0,1,0],[1,1,1],[0,0,0]],color:e.COLORS.T}],o=Math.floor(Math.random()*t.length),{shape:i,color:s}=t[o];return new h(i,s)}drawTetromino(t,o,i,s){t.fillStyle=s;for(let r=0;r<this.shape.length;r++)for(let n=0;n<this.shape[r].length;n++)this.shape[r][n]&&(t.fillRect((o+n)*e.BLOCK_SIZE,(i+r)*e.BLOCK_SIZE,e.BLOCK_SIZE,e.BLOCK_SIZE),t.lineWidth=1,t.strokeStyle="gray",t.strokeRect((o+n)*e.BLOCK_SIZE,(i+r)*e.BLOCK_SIZE,e.BLOCK_SIZE,e.BLOCK_SIZE))}drawNext(t,o=0,i=0){const s=e.BLOCK_SIZE;this.shape.forEach((r,n)=>{r.forEach((l,c)=>{l&&(t.fillStyle=this.color,t.fillRect((c+o)*s,(n+i)*s,s,s),t.strokeRect((c+o)*s,(n+i)*s,s,s))})})}}class u{constructor(t,o){this.score=e.INITIAL_SCORE,this.scoreWindow=t,this.playSoundEffect=o}async updateScore(t){let o=0;switch(t){case 1:o=100;break;case 2:o=200;break;case 3:o=400;break;case 4:o=800;break;default:o=0;break}if(this.score+=o,this.scoreWindow.innerHTML=`
      <h2>${this.score}</h2>
    `,o>0)for(let i=0;i<t;i++)await this.playSoundEffect("CLEAR_LINE")}}class S{constructor(t,o){this.canvas=t,this.ctx=t.getContext("2d"),this.board=Array.from({length:e.BOARD_ROWS},()=>Array(e.BOARD_COLUMNS).fill(null)),this.score=o}drawBoard(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<e.BOARD_ROWS;t++)for(let o=0;o<e.BOARD_COLUMNS;o++)this.board[t][o]!==null&&(this.ctx.fillStyle=this.board[t][o],this.ctx.fillRect(o*e.BLOCK_SIZE,t*e.BLOCK_SIZE,e.BLOCK_SIZE,e.BLOCK_SIZE),this.ctx.strokeRect(o*e.BLOCK_SIZE,t*e.BLOCK_SIZE,e.BLOCK_SIZE,e.BLOCK_SIZE));this.ctx.lineWidth=1,this.ctx.strokeStyle="gray";for(let t=0;t<e.BOARD_ROWS;t++)for(let o=0;o<e.BOARD_COLUMNS;o++)this.ctx.strokeRect(o*e.BLOCK_SIZE,t*e.BLOCK_SIZE,e.BLOCK_SIZE,e.BLOCK_SIZE)}clearAndUpdateScore(){let t=[];for(let o=0;o<e.BOARD_ROWS;o++)this.board[o].every(i=>i!=null)&&t.push(o);t.forEach(o=>{this.board.splice(o,1),this.board.unshift(Array(e.BOARD_COLUMNS).fill(null))}),t.length>0&&this.score.updateScore(t.length)}}class I{constructor(t){this.soundEffects={},this.cacheSounds(t)}cacheSounds(t){for(const[o,i]of Object.entries(t)){const s=new Audio(i);this.soundEffects[o]=s}}async playSoundEffect(t){const o=this.soundEffects[t];if(o)return new Promise((i,s)=>{o.play().catch(r=>{console.error("効果音の再生に失敗しました: ",r),s(r)}),o.onended=()=>i()});console.warn(`指定された音声 "${t}" がキャッシュされていません`)}}class m{constructor(t,o){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.scoreWindow=document.getElementById(o),this.currentTetromino=h.generateRandomTetromino(),this.ghostTetromino=this.currentTetromino,this.nextTetromino=h.generateRandomTetromino(),this.soundManager=new I(e.SOUND_EFFECTS),this.score=new u(this.scoreWindow,this.soundManager.playSoundEffect.bind(this.soundManager)),this.boardInstance=new S(this.canvas,this.score),this.board=this.boardInstance.board,this.fallInterval=e.FALL_INTERVALS.INITIAL,this.lastFallTime=0,this.xPosition=e.START_X_POSITION,this.yPosition=e.START_Y_POSITION,this.ghostXPosition=this.xPosition,this.ghostYPosition=this.yPosition,document.addEventListener("keydown",i=>this.controlTetromino(i)),this.gameOverFlag=!1,this.startTime=null}startGame(){this.gameLoop(),this.startTime=Date.now()}gameLoop(t){if(this.isGameOver()){this.gameOver();return}t-this.lastFallTime>=this.fallInterval&&(this.lastFallTime=t,this.moveTetrominoDown()),this.adjustFallInterval(),this.boardInstance.clearAndUpdateScore(),this.boardInstance.drawBoard(),this.currentTetromino.drawTetromino(this.ctx,this.xPosition,this.yPosition,this.currentTetromino.color),this.ghostTetromino.drawTetromino(this.ctx,this.ghostXPosition,this.ghostYPosition,e.COLORS.GHOST),this.updateGhostTetromino(),this.drawNextTetromino(),this.animationFrameId=requestAnimationFrame(this.gameLoop.bind(this))}drawNextTetromino(){const t=document.getElementById("next-tetromino");if(!t)return;const o=t.getContext("2d");o.clearRect(0,0,t.width,t.height);const i=this.nextTetromino.color===e.COLORS.I?0:1,s=this.nextTetromino.color===e.COLORS.I?0:1;this.nextTetromino.drawNext(o,i,s)}moveTetrominoDown(){this.yPosition++,this.isTetrominoAtBottom()&&this.freezeAndGenerateTetromino()}rotateTetromino(){const t=this.currentTetromino.shape[0].map((i,s)=>this.currentTetromino.shape.map(r=>r[s]).reverse());let o=0;for(;this.isTetrominoOutOfBounds(t,this.xPosition+o);)if(o+=this.xPosition>0?-1:1,Math.abs(o)>t[0].length)return;this.isTetrominoOverlapping(t,this.xPosition+o,this.yPosition)||(this.currentTetromino.shape=t,this.xPosition+=o)}isTetrominoOutOfBounds(t,o){return t.some(i=>i.some((s,r)=>{if(s){const n=o+r;return n<0||n>=this.board[0].length}return!1}))}isTetrominoOverlapping(t,o,i){return t.some((s,r)=>s.some((n,l)=>{if(n){const c=o+l,T=i+r;return this.board[T]&&this.board[T][c]}return!1}))}controlTetromino(t){if(t.key===e.ARROW_LEFT)this.isTetrominoAtSides(e.DIRECTION_LEFT)||this.xPosition--;else if(t.key===e.ARROW_RIGHT)this.isTetrominoAtSides(e.DIRECTION_RIGHT)||this.xPosition++;else if(t.key===e.ARROW_DOWN)this.moveTetrominoDown();else if(t.key===e.SPACE_KEY)for(;!this.isTetrominoAtBottom();)this.yPosition++;else t.key===e.ARROW_UP&&this.rotateTetromino();this.isTetrominoAtBottom()&&this.freezeAndGenerateTetromino()}isTetrominoAtSides(t){for(let o=0;o<this.currentTetromino.shape.length;o++)for(let i=0;i<this.currentTetromino.shape[o].length;i++)if(this.currentTetromino.shape[o][i]){const s=t===e.DIRECTION_LEFT?this.xPosition+i-1:this.xPosition+i+1;if(s<0||s>=e.BOARD_COLUMNS||this.board[this.yPosition+o][s])return!0}return!1}updateGhostTetromino(){for(this.ghostXPosition=this.xPosition,this.ghostYPosition=this.yPosition;!this.isGhostTetrominoAtBottom();)this.ghostYPosition++}isTetrominoAtBottom(){for(let t=0;t<this.currentTetromino.shape.length;t++)for(let o=0;o<this.currentTetromino.shape[t].length;o++)if(this.currentTetromino.shape[t][o]&&(this.yPosition+t>=e.BOARD_ROWS-1||this.board[this.yPosition+t+1][this.xPosition+o]))return!0;return!1}isGhostTetrominoAtBottom(){for(let t=0;t<this.ghostTetromino.shape.length;t++)for(let o=0;o<this.ghostTetromino.shape[t].length;o++)if(this.ghostTetromino.shape[t][o]&&(this.ghostYPosition+t>=e.BOARD_ROWS-1||this.board[this.ghostYPosition+t+1][this.ghostXPosition+o]))return!0;return!1}freezeTetromino(){for(let t=0;t<this.currentTetromino.shape.length;t++)for(let o=0;o<this.currentTetromino.shape[t].length;o++)this.currentTetromino.shape[t][o]&&(this.board[this.yPosition+t][this.xPosition+o]=this.currentTetromino.color)}freezeAndGenerateTetromino(){this.freezeTetromino(),this.currentTetromino=this.nextTetromino,this.nextTetromino=h.generateRandomTetromino(),this.xPosition=e.START_X_POSITION,this.yPosition=e.START_Y_POSITION,this.ghostTetromino=this.currentTetromino,this.drawNextTetromino()}adjustFallInterval(){Date.now()-this.startTime>=e.FALL_INTERVALS.STEP&&(this.fallInterval=Math.max(e.FALL_INTERVALS.MIN,this.fallInterval-e.FALL_INTERVALS.REDUCTION),this.startTime=Date.now())}isGameOver(){if(this.gameOverFlag)return!1;for(let t=0;t<this.currentTetromino.shape.length;t++)for(let o=0;o<this.currentTetromino.shape[t].length;o++)if(this.currentTetromino.shape[t][o]){const i=this.xPosition+o,s=this.yPosition+t;if(s<0||this.board[s]&&this.board[s][i])return!0}return!1}gameOver(){if(this.gameOverFlag)return;if(this.gameOverFlag=!0,cancelAnimationFrame(this.animationFrameId),!confirm(`Your Score: ${this.score.score}
再プレイしますか？`))d();else{const o=new m("tetris-board","score-window");o.scoreWindow.innerHTML=`
        <h2>${o.score.score}</h2>
      `,o.startGame()}}}function R(){const a=document.getElementById("app");a.innerHTML=`
    <div class="full-height center-flex">
      <div id="game-ground">
        <div id="score-window">
          <h2>0</h2>
        </div>
        <div class="m-2 text-center p-1">
          <button id="backToTopButton">TOP画面へ</button>
        </div>
        <canvas id="tetris-board" width="300" height="600"></canvas>
        <div class="next-tetromino mt-2">
          <h3>NEXT</h3>
          <canvas id="next-tetromino" width="120" height="120"></canvas>
        </div>
      </div>
    </div>
  `,document.getElementById("backToTopButton").addEventListener("click",()=>{O(()=>import("./index-BvqugAhF.js").then(i=>i.t),__vite__mapDeps([0,1])).then(i=>i.renderTopPage())}),new m("tetris-board","score-window").startGame()}export{R as renderGamePage};
